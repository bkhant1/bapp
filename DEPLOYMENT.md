# Deployment Setup Guide

## Overview
This project uses GitHub Actions for automated CI/CD with Terraform for infrastructure provisioning and Docker for containerization.

## Required GitHub Secrets

Configure these secrets in your GitHub repository (`Settings > Secrets and variables > Actions`):

### Google Cloud Platform
- **`GCP_PROJECT_ID`**: Your Google Cloud project ID (e.g., `bookexchange-1755188197`)
- **`GCP_SA_KEY`**: Service account JSON key with the following roles:
  - Cloud Run Admin
  - Cloud SQL Admin
  - Compute Admin
  - Storage Admin
  - Project IAM Admin
  - Service Account Admin

### Database
- **`DATABASE_PASSWORD`**: Secure password for the PostgreSQL database
- **`DATABASE_URL`**: Full PostgreSQL connection string (auto-generated by Terraform)

### Storage
- **`GCS_BUCKET_NAME`**: Google Cloud Storage bucket name for media files (auto-generated by Terraform)

## Pre-deployment Setup

### 1. Create Google Cloud Project
```bash
gcloud projects create bookexchange-1755188197
gcloud config set project bookexchange-1755188197
```

### 2. Enable Billing
Enable billing for your project in the Google Cloud Console.

### 3. Create Service Account
```bash
gcloud iam service-accounts create github-actions \
    --description="Service account for GitHub Actions" \
    --display-name="GitHub Actions"

# Grant necessary roles
gcloud projects add-iam-policy-binding bookexchange-1755188197 \
    --member="serviceAccount:github-actions@bookexchange-1755188197.iam.gserviceaccount.com" \
    --role="roles/run.admin"

gcloud projects add-iam-policy-binding bookexchange-1755188197 \
    --member="serviceAccount:github-actions@bookexchange-1755188197.iam.gserviceaccount.com" \
    --role="roles/cloudsql.admin"

# Add more roles as needed...

# Create and download key
gcloud iam service-accounts keys create github-actions-key.json \
    --iam-account=github-actions@bookexchange-1755188197.iam.gserviceaccount.com
```

### 4. Create Terraform State Bucket
```bash
gsutil mb gs://bookexchange-terraform-state
gsutil versioning set on gs://bookexchange-terraform-state
```

## Deployment Workflow

### On Pull Requests
1. **Testing**: Runs backend and frontend tests
2. **Security Scan**: Trivy vulnerability scanning
3. **Terraform Plan**: Shows infrastructure changes (comment on PR)

### On Main Branch Push
1. **Testing**: Runs all tests
2. **Terraform Apply**: Provisions/updates infrastructure
3. **Docker Build**: Builds and pushes images to GCR
4. **Cloud Run Deploy**: Deploys applications to Cloud Run

## Infrastructure Resources

The Terraform configuration creates:

- **Cloud Run** services (backend and frontend)
- **Cloud SQL** PostgreSQL database
- **Cloud Storage** bucket for media files
- **VPC** network for private connectivity
- **Redis** instance for caching
- **VPC Access Connector** for Cloud Run to Cloud SQL communication

## Monitoring and Troubleshooting

### Check Deployment Status
```bash
# View Cloud Run services
gcloud run services list --region=europe-west2

# View Cloud SQL instances
gcloud sql instances list

# Check application logs
gcloud logs read "resource.type=cloud_run_revision" --limit=50
```

### Common Issues

1. **Permission Errors**: Ensure service account has all required roles
2. **Region Mismatch**: Verify all resources use `europe-west2`
3. **Database Connection**: Check VPC Access Connector is properly configured
4. **Image Pull Errors**: Verify Docker images are pushed to correct GCR repository

## Manual Deployment

If needed, you can deploy manually:

```bash
# Infrastructure
cd infra
terraform init
terraform plan -var="project_id=bookexchange-1755188197" -var="database_password=your-password"
terraform apply

# Docker Images
cd ../backend
docker build -t gcr.io/bookexchange-1755188197/bookexchange-backend .
docker push gcr.io/bookexchange-1755188197/bookexchange-backend

cd ../frontend
docker build -t gcr.io/bookexchange-1755188197/bookexchange-frontend .
docker push gcr.io/bookexchange-1755188197/bookexchange-frontend
```

## Security Considerations

- Database password should be generated securely
- Service account keys should be rotated regularly
- Enable audit logging for production environments
- Use least-privilege IAM roles
- Regular security scanning is automated via Trivy 